As data is inserted, updated, and deleted from indexes the logical ordering in the index will no longer match the physical ordering inside of the pages, and between the pages, making up the indexes. Also, over time the data modifications can cause the data to become scattered or fragmented in the database. This fragmentation can degrade query performance when the database engine needs to read additional pages in order to locate needed data.

The SQL Server and Azure SQL platforms offer DMVs that allow you to detect fragmentation in your objects using the following DMVs. The most commonly used DMVs for this purpose are: sys.dm_db_index_physical_stats, for b-tree indexes, and sys.dm_db_colum_store_row_group_physical_stats, for columnstore indexes.

There are two options for index maintenance: reorganization, and rebuilding. Reorganization defragments an index by physically reordering the leaf-level index pages to match the logical sorted order of the leaf nodes and compacts the index pages based on the index’s fill factor setting. Rebuilding an index drops and recreates the pages of the index. The typical guidelines for deciding to rebuild versus reorganizing an index is that when fragmentation is greater than 30% that the index should be rebuilt. However, the actual values vary from case to case. If an index is used heavily for scan operations, removing excess pages may help significantly, however there will be limited benefits for seek operations. Reorganization has the benefit of being an online activity, whereas rebuilding requires a special ONLINE option. Indexes that have less than 5% fragmentation do not need to be defragmented, because the cost of defragmentation is greater than the performance benefits that could be gained. Whenever you are considering either rebuilding or reorganizing, you should verify that doing so does provide performance improvements.

SQL Server 2017 introduced resumable index maintenance operations. This option allows index maintenance operations to be paused, or take place in a time window, and be resumed later. A good example of where to use resumable index operations is to reduce the impact of index maintenance in a busy production environment, as you can perform rebuild operations during a specific maintenance window giving you more control over the process.

One other thing to note is that index rebuilds cause the statistics on the index to be updated, which can further help performance. Index reorganization does not update statistics.

## Columnstore maintenance

Columnstore index fragmentation is not reported in same manner as b-tree index fragmentation. Examine the sys.dm_dm_colum_store_row_group_physical_stats for deleted rows—which will be caused by both update and delete operations. A good metric to measure fragmentation in a columnstore index is based on the deleted rows in the index. If 20% or more of the rows are deleted, you should consider reorganizing your index. In a test environment, verify whether a reorganization improves the performance of the workloads using the columnstore index.
