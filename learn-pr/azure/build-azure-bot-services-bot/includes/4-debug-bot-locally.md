### Exercise 4: Debug the bot locally

As with any application code that you write, changes to bot code need to be tested and debugged locally before being deployed to production. To help debug bots, Microsoft offers the [Bot Framework Emulator](https://emulator.botframework.com/). In this exercise, you will learn how to use Visual Studio Code and the emulator to debug your bots.

1. If you haven't installed the Microsoft Bot Framework Emulator, take a moment to do so now. You can download it from https://emulator.botframework.com/. Versions are available for Windows, macOS, and Linux.

1. Execute the following command in Visual Studio Code's integrated terminal to install [Restify](http://restify.com/), a popular Node package for building and consuming RESTful Web services:

	```
	npm install restify
	```

1. Repeat this step for the following commands to install the [Microsoft Bot Framework Bot Builder SDK for Node.js](https://docs.microsoft.com/en-us/bot-framework/nodejs/bot-builder-nodejs-quickstart):

	```
	npm install botbuilder
	npm install botbuilder-azure
	npm install botbuilder-cognitiveservices
	```

1. Click the **Explorer** button in Visual Studio Code's activity bar. Then select **app.js** to open it in the code editor. This file contains the code that drives the bot â€” code that was generated by the Azure Bot Service and downloaded from the Azure portal.

    ![Opening app.js](../images/vs-select-index-js.png)

    _Opening app.js_ 

1. Replace the contents of **app.js** with the following code. Then save the file:

	```JavaScript
	"use strict";
	var builder = require("botbuilder");
	var botbuilder_azure = require("botbuilder-azure");
	
	var useEmulator = true; 
	var userName = ""; 
	var yearsCoding = ""; 
	var selectedLanguage = "";
	
	var connector = useEmulator ? new builder.ChatConnector() : new botbuilder_azure.BotServiceConnector({
	    appId: process.env.MicrosoftAppId,
	    appPassword: process.env.MicrosoftAppPassword	   
	});
	
	var bot = new builder.UniversalBot(connector);
	
	bot.dialog('/', [
	
	function (session) {
	    builder.Prompts.text(session, "Hello, and welcome to QnA Factbot! What's your name?");
	},
	
	function (session, results) {
	    userName = results.response;
	    builder.Prompts.number(session, "Hi " + userName + ", how many years have you been writing code?"); 
	},
	
	function (session, results) {
	    yearsCoding = results.response;
	    builder.Prompts.choice(session, "What language do you love the most?", ["C#", "Python", "Node.js", "Visual FoxPro"]);
	},
	
	function (session, results) {
	    selectedLanguage = results.response.entity;   
	
	    session.send("Okay, " + userName + ", I think I've got it:" +
	                " You've been writing code for " + yearsCoding + " years," +
	                " and prefer to use " + selectedLanguage + ".");
	}]);
	 
	var restify = require('restify');
	var server = restify.createServer();

	server.listen(3978, function() {
	    console.log('test bot endpoint at http://localhost:3978/api/messages');
	});

	server.post('/api/messages', connector.listen());    
	```

1. Set breakpoints on lines 20, 25, and 30 by clicking in the margin on the left.
 
    ![Adding breakpoints to app.js](../images/vs-add-breakpoints.png)

    _Adding breakpoints to app.js_ 

1. Click the **Debug** button in the activity bar, and then click the green arrow to start a debugging session. Confirm that "test bot endpoint at http://localhost:3978/api/messages" appears in the debug console.
 
    ![Launching the debugger](../images/vs-launch-debugger.png)

    _Launching the debugger_ 

1. Your bot code is now running locally. Launch the Bot Framework Emulator and click **Create a new bot configuration**. Enter the bot name and the bot URL displayed in the debug console in the previous step. Then click **Save and connect** and save the configuration file in the location of your choice.

	> In the future, you can reconnect to the bot simply by clicking the bot name under "My Bots."

    ![Connecting to the bot](../images/new-bot-configuration.png)

    _Connecting to the bot_ 

1. Type "hi" into the box at the bottom of the emulator and press **Enter**. Confirm that Visual Studio Code breaks on line 20 of **app.js**. Then click the **Continue** button in Visual Studio Code's debugging toolbar and return to the emulator to see the bot's response.
 
    ![Continuing in the debugger](../images/continue-debugging.png)

    _Continuing in the debugger_ 

1. The bot will ask you a series of questions. Answer them and click **Continue** in Visual Studio Code each time a breakpoint is hit. When you're done, click the **Stop** button in the debugging toolbar to end the debugging session.

At this point, you have a fully functioning bot and know how to debug it by running it locally in the Microsoft Bot Emulator. The next step is to make the bot more intelligent by connecting it to the knowledge base you published in [Exercise 2](#Exercise2).