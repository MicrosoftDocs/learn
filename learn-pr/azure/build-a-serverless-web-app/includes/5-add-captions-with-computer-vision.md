At this point, the application is a functional gallery that allows you to upload and view images. In this module, you learn how to use the Computer Vision API from Microsoft Cognitive Services to generate captions for uploaded images and save the captions with the image metadata in Azure Cosmos DB.

## Create a Computer Vision account

Microsoft Cognitive Services is a collection of services that are available to developers to make their applications more intelligent. The Computer Vision API is a serverless service that processes images using advanced algorithms and returns information about each image. It has a free tier that provides up to 5,000 API calls per month.

Create a new Cognitive Services account of type **ComputerVision** with a unique name in your resource group. For the free tier, use **F0** as the SKU. If you already have an existing Computer Vision account, you may need to create a Standard account (S1), which may incur some costs.

```azurecli
az cognitiveservices account create \
    -g <rgn>[Sandbox resource group name]</rgn> \
    -n <computer vision account name> \
    --kind ComputerVision \
    --sku F0 \
    --location $(az group show -n <rgn>[Sandbox resource group name]</rgn> --query location -o tsv)
```

When prompted to accept the data consent notice, enter `y` and press `Enter`. The command may take a minute or two to complete.

## Create function app settings for Computer Vision URL and key

To call the Computer Vision API, a URL and key are required.

1. Get the Computer Vision API key and URL and save them in Bash variables.

    ```azurecli
    export COMP_VISION_KEY=$(az cognitiveservices account keys list -g <rgn>[Sandbox resource group name]</rgn> -n <computer vision account name> --query key1 --output tsv)
    export COMP_VISION_URL=$(az cognitiveservices account show -g <rgn>[Sandbox resource group name]</rgn> -n <computer vision account name> --query endpoint --output tsv)
    ```

1. Create app settings named **COMP_VISION_KEY** and **COMP_VISION_URL**, respectively, in the function app.

    ```azurecli
    az functionapp config appsettings set \
        -n <function app name> \
        -g <rgn>[Sandbox resource group name]</rgn> \
        --settings COMP_VISION_KEY=$COMP_VISION_KEY COMP_VISION_URL=$COMP_VISION_URL -o table
    ```

## Call the Computer Vision API from the ResizeImage function

In the following steps, you modify the **ResizeImage** function to call the Computer Vision API to describe each uploaded image and save the description in Azure Cosmos DB.

1. Sign into the [Azure portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true) using the same account you activated the sandbox with.

1. Open your function app.

::: zone pivot="csharp"

3. Using the left navigation, locate the **ResizeImage** function and open its code window.

1. Replace the code with the contents of the [**/csharp/ResizeImage/run-module5.csx**](https://raw.githubusercontent.com/Azure-Samples/functions-first-serverless-web-application/master/csharp/ResizeImage/run-module5.csx) file. This code uses `HttpClient` to call the Computer Vision API and save its result in Azure Cosmos DB.

1. Click **Logs** below the code window to expand the Logs panel.

1. Click **Save**. Check the Logs panel to ensure the function is successfully saved and there are no errors.

::: zone-end

::: zone pivot="javascript"

2. This function requires the `axios` package from npm to make an HTTP call to the Computer Vision API. To install the npm package, click on the function app name on the left navigation and click **Platform features**.

1. Click **Console** to reveal a console window.

1. Run the command `npm install axios` in the console. It may take a few minutes to complete the operation.

1. Click on the function name (**ResizeImage**) in the left navigation to reveal the function. Replace all of the **index.js** file with the contents of the [**/javascript/ResizeImage/index-module5.js**](https://raw.githubusercontent.com/Azure-Samples/functions-first-serverless-web-application/master/javascript/ResizeImage/index-module5.js) file.

1. Click **Logs** below the code window to expand the Logs panel.

1. Click **Save**. Check the Logs panel to ensure the function is successfully saved and there are no errors.

::: zone-end

## Test the application

1. Open the application in a browser.

1. Select an image file and upload it.

1. After a few seconds, the thumbnail of the new image should appear on the page. Point to the image to see the description that's generated by Computer Vision.

## Summary

In this unit, you learned how to automatically generate captions for each uploaded image using Microsoft Cognitive Services Computer Vision API. Next, you learn how to add authentication to the application using Azure App Service authentication.