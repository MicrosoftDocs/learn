## Scenario

A Key Vault customer would like to securely transfer a key from their on-premises Hardware Security Module (HSM) outside Azure, into the HSM backing Azure Key Vault. The process of importing a key generated outside Key Vault is referred to as Bring Your Own Key (BYOK).

The following are the requirements:

 -  The key to be transferred never exists outside an HSM in plain text form.
 -  Outside an HSM, the key to be transferred is always protected by a key held in the Azure Key Vault HSM.

## Terminology

| **Key Name**           | **Key Type**                    | **Origin**          | **Description**                                           |
| ---------------------- | ------------------------------- | ------------------- | --------------------------------------------------------- |
| Key Exchange Key (KEK) | RSA                             | Azure Key Vault HSM | An HSM backed RSA key pair generated in Azure Key Vault   |
| Wrapping Key           | AES                             | Vendor HSM          | An \[**ephemeral**\] AES key generated by HSM on-premises |
| Target Key             | RSA, EC, AES (Managed HSM only) | Vendor HSM          | The key to be transferred to the Azure Key Vault HSM      |

**Key Exchange Key**: An HSM-backed key that customer generates in the key vault where the BYOK key will be imported. This KEK must have following properties:

 -  It’s an RSA-HSM key (4096-bit or 3072-bit or 2048-bit)<br>
 -  It will have fixed key\_ops (ONLY ‘import’), that will allow it to be used ONLY during BYOK
 -  Must be in the same vault where the Target Key will be imported

## User steps

To perform a key transfer, a user performs following steps:

1. Generate KEK.

2. Retrieve the public key of the KEK.

3. Using HSM vendor provided BYOK tool - Import the KEK into the target HSM and exports the Target Key protected by the KEK.

4. Import the protected Target Key to Azure Key Vault.

Customers use the BYOK tool and documentation provided by HSM vendor to complete Steps 3. It produces a Key Transfer Blob (a ".byok" file).

## HSM constraints

Existing HSM may apply constraints on key that they manage, including:

 -  The HSM may need to be configured to allow key wrap-based export<br>
 -  The target key may need to be marked **Cryptoki Attribute (CKA)**\_EXTRACTABLE for the HSM to allow controlled export
 -  In some cases, the KEK and wrapping key may need to be marked as CKA\_TRUSTED, which allows it to be used to wrap keys in the HSM.

The configuration of source HSM is, generally, outside the scope of this specification. Microsoft expects the HSM vendor to produce documentation accompanying their BYOK tool to include any such configuration steps.

> [!NOTE]
> Several of these steps can be performed using other interfaces such as Azure PowerShell and Azure portal. They can also be performed programmatically using equivalent functions in Key Vault SDK.

### Generate KEK

Use the **az keyvault key create** command to create KEK with key operations set to import. Note down the key identifier 'kid' returned from the below command.

```azurecli
Azure CLI
```

```azurecli
az keyvault key create --kty RSA-HSM --size 4096 --name KEKforBYOK --ops import --vault-name ContosoKeyVaultHSM
```

Services support different KEK lengths; Azure SQL, for instance, only supports key lengths of 2048 or 3072 bytes.

### Retrieve the public key of the KEK<br>

Download the public key portion of the KEK and store it into a PEM file.

```azurecli
Azure CLI
```

```azurecli
az keyvault key download --name KEKforBYOK --vault-name ContosoKeyVaultHSM --file KEKforBYOK.publickey.pem

```

## Generate key transfer blob using HSM vendor provided BYOK tool<br>

Customer uses HSM Vendor provided BYOK tool to create a key transfer blob (stored as a ".byok" file). KEK public key as a **.Privacy-Enhanced Mail** (.pem file) will be one of the inputs to this tool.

### Key Transfer Blob

Long term, Microsoft would like to use **Public Key Cryptography Standards** (PKCS) \#11 **Cryptoki Attribute Mechanism** (CKM)\_**Rivest–Shamir–Adleman** (RSA)\_**Advanced Encryption Standard (AES)**\_**Key Exchange Key** (KEY)\_WRAP mechanism to transfer the target key to Azure Key Vault since this mechanism produces a single blob and, more importantly, the intermediate AES key is handled by the two HSMs and is guaranteed to be ephemeral. This mechanism isn't presently available in some HSMs but the combination of protecting the target key with CKM\_AES\_KEY\_WRAP\_PAD using an AES key and protecting the AES key with CKM\_RSA\_PKCS\_**Optimal Asymmetric Encryption Padding** (OAEP) produces an equivalent blob.

The target key plaintext depends on the key type:

 -  For an RSA key, the private key **Abstract Syntax Notation.1** (ASN.1) **DistinguishedEncoding Rules** (DER) encoding Request for Comments \[RFC3447\] wrapped in PKCS\#8 \[RFC5208\].
 -  For an **Elliptic Curve key-pair** (EC key), the private key ASN.1 DER encoding \[RFC5915\] wrapped in PKCS\#8 \[RFC5208\].
 -  For an octet key, the raw bytes of the key.

The bytes for the plaintext key are then transformed using the CKM\_RSA\_AES\_KEY\_WRAP mechanism:

 -  An ephemeral AES key is generated and encrypted with the wrapping RSA key using RSA-OAEP with **Secure Hash Algorithm** (SHA1).
 -  The encoded plaintext key is encrypted using the AES key using AES Key Wrap with Padding.
 -  The encrypted AES key and the encrypted plaintext key are concatenated to produce the final ciphertext blob.

The format of the transfer blob uses **JavaScript Object Notation** (JSON) Web Encryption compact serialization (RFC7516) primarily as a vehicle for delivering the required metadata to the service for correct decryption.

## Upload key transfer blob to import HSM-key<br>

Customer transfers the Key Transfer Blob (".byok" file) to an online workstation and then run an az keyvault key import command to import this blob as a new HSM-backed key into Key Vault.

To import an RSA key, use this command:

```azurecli
Azure CLI
```

```azurecli
az keyvault key import --vault-name ContosoKeyVaultHSM --name ContosoFirstHSMkey --byok-file KeyTransferPackage-ContosoFirstHSMkey.byok --ops encrypt decrypt
```

To import an EC key, you must specify key type and the curve name.

```azurecli
Azure CLI
```

```azurecli
az keyvault key import --vault-name ContosoKeyVaultHSM --name ContosoFirstHSMkey --byok-file --kty EC-HSM --curve-name "P-256" KeyTransferPackage-ContosoFirstHSMkey.byok --ops sign verify
```

When the above command is executed, it results in sending a REST API request as follows:

<!--- raw content start --->
PUT https://contosokeyvaulthsm.vault.azure.net/keys/ContosoFirstHSMKey?api-version=7.0
<!--- raw content end --->

Request body when importing an RSA key:

```javascript
JSON
```

```javascript
{
```

```javascript
  "key": {
```

```javascript
    "kty": "RSA-HSM",
```

```javascript
    "key_ops": [
```

```javascript
      "decrypt",
```

```javascript
      "encrypt"
```

```javascript
    ],
```

```javascript
    "key_hsm": "<Base64 encoded BYOK_BLOB>"
```

```javascript
  },
```

```javascript
  "attributes": {
```

```javascript
    "enabled": true
```

```javascript
  }
```

```javascript
}
```

```javascript
Request body when importing an EC key:

```

```javascript
JSON
```

```javascript
{
```

```javascript
  "key": {
```

```javascript
    "kty": "EC-HSM",
```

```javascript
    "crv": "P-256",
```

```javascript
    "key_ops": [
```

```javascript
      "sign",
```

```javascript
      "verify"
```

```javascript
    ],
```

```javascript
    "key_hsm": "<Base64 encoded BYOK_BLOB>"
```

```javascript
  },
```

```javascript
  "attributes": {
```

```javascript
    "enabled": true
```

```javascript
  }
```

```javascript
}
```

“key\_hsm” value is the entire contents of the KeyTransferPackage-ContosoFirstHSMkey.byok encoded in the Base64 format.
