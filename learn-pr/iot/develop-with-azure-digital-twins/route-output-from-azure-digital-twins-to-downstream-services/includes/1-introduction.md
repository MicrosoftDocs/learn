:::image type="content" source="../media/azure-digital-twins-time-series-insights-flow.png" alt-text="The diagram illustrates the flow of data from Azure Digital Twins to Time Series Insights":::

In an Azure Digital Twins solution, you can route event notifications to downstream services or connected compute resources. This is done by first setting up *endpoints* that can receive the events. You can then create *event routes* that specify which events generated by Azure Digital Twins are delivered to which endpoints.

There are many other services where you may want to ultimately direct your data, such as [Azure Storage](https://docs.microsoft.com/azure/storage/common/storage-introduction), [Azure Maps](https://docs.microsoft.com/azure/azure-maps/about-azure-maps), or [Time Series Insights](https://docs.microsoft.com/azure/time-series-insights/time-series-insights-update-overview). To send your data to services like these, first you need to attach the destination service to an *endpoint*.

## How do event routes work?

Endpoints are attached to Azure Digital Twins using management APIs or the Azure portal. For more information on how to attach an endpoint to Azure Digital Twins, see the [guide for managing endpoints and routes](https://docs.microsoft.com/azure/digital-twins/how-to-manage-routes-apis-cli).

- Event routes use [Event Hub](https://docs.microsoft.com/azure/event-hubs/event-hubs-about), [Event Grid](https://docs.microsoft.com/azure/event-grid/overview), or [Service Bus](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview) to drive your desired data flows
- All events incoming to or generated by Azure Digital Twins flow into a common event stream
- Developers can define routes to pick a subset of data items of the event stream and send them to endpoints

In this module, you'll learn how to route events to Time Series Insights for querying and visualizing events received from Azure Digital Twins.

## What is Azure Time Series Insights?

[Azure Time Series Insights](https://azure.microsoft.com/services/time-series-insights/) is an analytics platform to monitor, analyze, and visualize your industrial IoT data at scale. It also enables simple windowed compute in operational contexts to answer root-cause-analysis-type questions where operators and developers need more than last-known-values using real-time or near real-time insights from analytics to achieve operational optimization and excellence. For more information on Time Series Insights, see the following resources:

- [Time Series Insights Documentation](https://docs.microsoft.com/azure/time-series-insights/time-series-insights-overview)
- [Time Series Insights Learn module to explore and analyze time-stamped data](https://docs.microsoft.com/learn/modules/explore-analyze-time-series-insights/)

## Azure Digital Twins events

In many cases, data from Azure Digital Twins needs to be sent to downstream services for further analysis, integration, simulation, or processing. In this example, you'll explore how to send the data to a Time Series Insights instance to record time series data of manufacturing process events for bulk analytics.

Data egress is handled using *event routes*. An event route lets you send event data (such as telemetry events, life-cycle events, and property change events) from twins to defined endpoints in your subscriptions (such as an event hub, event grid, or a service bus).

Azure Digital Twins will emit the following events (notifications and telemetry messages) and they'll be routed to custom endpoints:

- Digital Twin Change Notification
- Digital Twin Lifecycle Notification
- Digital Twin Relationship Change Notification
- Digital Twin Telemetry Messages

| Notification type                    | Routing source name   | Generated from...  |
|--------------------------------------|-----------------------|--------------------|
| Digital Twin Change Notification     | Digital Twin Change Notification | Any digital twin property change |
| Digital Twin Lifecycle Notification  | Digital Twin Lifecycle Notification | Any digital twins create or delete operation |
| Digital Twin Relationship Change Notification  | Digital Twin Relationship Change Notification  | Any digital twin relationship change |
| Digital Twin Telemetry Messages      | Telemetry Messages        | Any telemetry message |

For more information about the different notification types displayed in the above table, see [the Azure Digital Twins event data article](https://docs.microsoft.com/azure/digital-twins/how-to-interpret-event-data).

## Endpoints

To define an event route, developers first must define **endpoints**. An endpoint is a connection to a destination outside of Azure Digital Twins. Supported destinations are:

- EventGrid
- EventHub
- ServiceBus

:::image type="content" source="../media/event-data-flow.png" alt-text="The diagram illustrates the flow of event data through a larger IoT solution with an Azure Digital Twins aspect":::

**The diagram illustrates the flow of event data through a larger IoT solution (a railway monitoring system) with an Azure Digital Twins aspect.**

## Routes

**Event routes** are defined using data plane APIs. A route definition contains:

- The desired route ID
- The desired endpoint ID
- A filter that defines which events are sent to the endpoint

Some of the services you can tap into using routes:

- Storing Azure Digital Twins data in [Azure Data Lake](https://docs.microsoft.com/azure/storage/blobs/data-lake-storage-introduction)
- Analyzing Azure Digital Twins data with [Azure Synapse Analytics](https://docs.microsoft.com/azure/synapse-analytics/sql-data-warehouse/sql-data-warehouse-overview-what-is), or other Microsoft data analytics tools
- Integrating larger workflows with Logic Apps
- Connecting Azure Digital Twins to Time Series Insights to track the time series history of each twin
- Aligning a Time Series Model in Time Series Insights with a source in Azure Digital Twins
- Route events to compute services like Azure Functions for advanced simulation or data processing

## Learning objectives

In this module, you will:

- Build and simulate the chocolate factory twin
- Create a route and filter to twin update notifications
- Create and configure an Azure function, and send telemetry to an event hub
- Create and connect a Time Series Insights instance
- Visualize and query your data in Time Series Insights

## Prerequisites

- It is recommended that you have introductory knowledge of Azure IoT, you can learn more by completing the [Introduction to Azure IoT](https://docs.microsoft.com/en-us/learn/paths/introduction-to-azure-iot/) Learning Path
- A basic understanding of the Azure CLI. Following [Control Azure services with the CLI](https://docs.microsoft.com/en-us/learn/modules/control-azure-services-with-cli/) module is recommended 
- [Azure Command Line Interface (CLI)](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)
  - It is recommended to install AZ CLI locally 
  - It is not recommended to use the Azure Cloud Shell as it will timeout due to the length of the lab 
- macOS: [PowerShell for Mac](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-core-on-macos?view=powershell-6)
- Windows OS: PowerShell is built in
- Access to an Azure subscription where you have the Global Administrator role for your account and Azure Active Directory Tenant to complete the exercise units
- It is recommended that you have some experience working with Time Series Insights, you can learn more by completing the [Explore and analyze time-stamped data with Time Series Insights](https://docs.microsoft.com/en-us/learn/modules/explore-analyze-time-series-insights/) module 
- [Node.js](https://nodejs.org/en/download/) to run the device simulator application  
- [Git](https://git-scm.com/downloads)
- [Visual Studio Code](https://code.visualstudio.com/)
- [.NET Core 3.1](https://dotnet.microsoft.com/download)
- [C# VS Code extension](https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csharp)
- [Azure Function VS Code extension](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions)
