
Using X.509 certificates as an attestation mechanism is an excellent way to scale production and simplify device provisioning. X.509 certificates are typically arranged in a certificate chain of trust in which each certificate in the chain is signed by the private key of the next higher certificate, and so on, terminating in a self-signed root certificate. This arrangement establishes a delegated chain of trust from the root certificate generated by a trusted root certificate authority (CA) down through each intermediate CA to the final "leaf" certificate installed on a device.

Often the certificate chain represents some logical or physical hierarchy associated with devices. For example, a manufacturer might reflect their production process with the following certificate chain:

* Issue a self-signed root CA certificate.
* Use the root certificate to generate a unique intermediate CA certificate for each factory.
* Use each factory's certificate to generate a unique intermediate CA certificate for each production line in the plant.
* And finally, use the production line certificate to generate a unique device (leaf) certificate for each device manufactured on the line.

### Root certificate

A root certificate, or root CA certificate, is a self-signed X.509 certificate representing a certificate authority (CA). The root is the terminus, or trust anchor, of the certificate chain. Root certificates can be self-issued by an organization or purchased from a root certificate authority.

### Intermediate certificate

An intermediate certificate, or intermediate CA certificate, is an X.509 certificate that has been signed by the root certificate or by another intermediate certificate in its chain. The last intermediate certificate in a chain is used to sign the leaf certificate.

### Device "leaf" certificate

The leaf certificate, or device certificate, uniquely identifies a device to the provisioning service. It has the root certificate in its certificate chain and zero or more intermediate certificates. The leaf certificate isn't used to sign any other certificates. During authentication, the device uses the private key associated with its certificate to respond to a proof of possession challenge from the service.

Any device that uses X.509 attestation must use its certificate Subject Name as its registration ID in DPS, which ultimately becomes its device ID in IoT Hub. In enrollment groups, the Subject Name is automatically used for the registration ID, but with individual enrollments the registration ID is defined manually.

## Control device access with X.509 certificates

You can manage devices that use the X.509 attestation mechanism with either individual or group enrollments:

* Individual enrollments are configured with the device certificate associated with a specific device. These lists control enrollments for specific devices.
* Enrollment groups are associated with a specific intermediate or root CA certificate. These lists control enrollments for all devices that have that intermediate or root certificate in their certificate chain.

Similarly to how the provisioning service checks for individual enrollments for a device before checking enrollment groups, the provisioning service also prioritizes specific certificates for X.509 devices. For example, an individual enrollment with the leaf certificate is prioritized over a group enrollment with an intermediate certificate. And a group enrollment with an intermediate certificate lower on the chain (closer to the device certificate) is prioritized over a group enrollment with an intermediate certificate higher on the chain.

This mechanism and the hierarchical structure of certificate chains provides powerful flexibility in how you can control access for both individual devices and groups of devices. For example, imagine five devices with the following certificate chains:

* Device 1: root certificate -&gt; certificate A -&gt; device 1 certificate
* Device 2: root certificate -&gt; certificate A -&gt; device 2 certificate
* Device 3: root certificate -&gt; certificate A -&gt; device 3 certificate
* Device 4: root certificate -&gt; certificate B -&gt; device 4 certificate
* Device 5: root certificate -&gt; certificate B -&gt; device 5 certificate

Initially, you can create a single enabled group enrollment entry for the root certificate to enable access for all five devices. If certificate B later becomes compromised, you can create a disabled enrollment group entry for certificate B to prevent devices 4 and 5 from enrolling. If device 3 becomes compromised, you can create a disabled individual enrollment entry for its certificate. This individual enrollment revokes access for device 3, but still allows devices 1 and 2 to enroll.
